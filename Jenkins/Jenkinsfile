def commonLib = evaluate readTrusted("Jenkins/Pipeline/common.groovy")
def terraformLib = evaluate readTrusted("Jenkins/Pipeline/terraform.groovy")
def lambdasLib = evaluate readTrusted("Jenkins/Pipeline/terraform.groovy")
def accessKey
def secretKey
def appFolder
def backendBucket
def awsRegion
def pipelineAction
def stateTable

pipeline {
    agent any

    environment {
        String API_UPLOAD_BUCKET = "api-bucket"
        String API_BUCKET_KEY = "api"
        String TERRAFORM_VERSION = "1.4.6"
    }

    parameters {
        choice(name: "APP_FOLDER", choices: ["terraform", "lambdas", "secret-manager", "src"], description: "Folder where pipeline actions should run")
        choice(name: "PIPELINE_ACTION", choices: ["test", "lambdas", "deploy-api", "build-and-deploy-api" , "init-and-plan", "apply", "destroy"], description: "Pipeline deploy action")
        password(name: "AWS_ACCESS_KEY", description: "AWS ACCESS KEY")
        password(name: "AWS_SECRET_KEY", description: "AWS SECRET KEY")
        choice(name: "CLOUD_ENVIRONMENT", choices: ["dev", "test", "prod"], description: "Deployment cloud environment")
        choice(name: "AWS_REGION", choices: ["us-east-1", "us-east-2", "us-west-1"], description: "AWS Region to deploy resources and app")
    }

    stages {
        stage("Set Variables") {
            steps {
                script {
                    pipelineAction = params.PIPELINE_ACTION
                    awsRegion = params.AWS_REGION
                    appFolder = params.APP_FOLDER
                    cloudEnv = params.CLOUD_ENVIRONMENT
                    accessKey = params.AWS_ACCESS_KEY
                    secretKey = params.AWS_SECRET_KEY

                    backendBucket = commonLib.getBucketName(awsRegion)
                    stateTable = commonLib.getDynamoDBStateTableName(awsRegion)
                    echo "App Folder: $appFolder"
                    echo "Backend State and storage bucket: $backendBucket"
                    echo "DynamoDB state table Name: $stateTable"
                    echo "Current AWS Region: $awsRegion"
                }
            }
        }

        stage("Update Node") {
            steps {
                script {
                    sh "apt-get update"
                }
            }
        }

        stage("Install AWS CLI") {
            steps {
                script {
                    commonLib.installAWSCLI()
                }
            }
        }

        stage("Build Terraform Environment") {
            when {
                expression {
                    return pipelineAction != "test" || pipelineAction != "deploy-api"
                }
            }

            steps {
                script {
                    terraformLib.buildTerraformEnvironment()
                }
            }
        }

        stage("Init and Plan") {
            when {
                expression {
                    return pipelineAction != "test" || pipelineAction != "deploy-api"
                }
            }

            steps {
                script {
                    terraformLib.terraformInit(backendBucket, appFolder, awsRegion, cloudEnv, stateTable, accessKey, secretKey)
                }
            }
        }

        stage("Build API Environment") {
            when {
                expression {
                    return pipelineAction == "deploy-api" || pipelineAction == "build-and-deploy-api"
                }
            }

            steps {
                script {
                    commonLib.buildKotlinEnvironment()
                }
            }
        }
    }
}